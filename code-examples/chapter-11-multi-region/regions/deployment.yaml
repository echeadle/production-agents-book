# Multi-Region Deployment Configuration
# Chapter 11: Multi-Region Deployment
#
# This file defines the deployment configuration for agent services
# across three primary regions to serve a global user base.

# =========================================================================
# Region: US-East (Primary)
# =========================================================================
regions:
  - name: us-east-1
    cloud_provider: aws
    location: Virginia, USA
    timezone: America/New_York (UTC-5)
    primary: true  # Primary region for US traffic

    # User population
    user_population:
      - North America (US, Canada, Mexico)
      - Total users: ~500,000
      - Peak traffic: 10,000 req/min

    # Infrastructure
    infrastructure:
      api_pods: 10
      worker_pods: 20
      redis_cluster:
        nodes: 6  # 3 primary + 3 replicas
        instance_type: cache.r6g.xlarge
        memory: 32GB
      postgres:
        instances: 3  # Primary + 2 replicas
        instance_type: db.r6g.2xlarge
        storage: 500GB

    # Claude API routing
    claude_api:
      endpoint: https://api.anthropic.com
      region_preference: us-east

    # Data residency
    data_residency:
      - US users: Data stored in us-east-1
      - Canadian users: Data can stay in us-east-1 (PIPEDA compliant)
      - Default for non-EU users

    # Networking
    networking:
      load_balancer: alb-agent-us-east.company.com
      public_endpoint: https://api-us.agent.company.com
      vpc_cidr: 10.0.0.0/16
      availability_zones: [us-east-1a, us-east-1b, us-east-1c]

# =========================================================================
# Region: EU-West (GDPR Compliance)
# =========================================================================
  - name: eu-west-1
    cloud_provider: aws
    location: Ireland
    timezone: Europe/Dublin (UTC+0)
    primary: false  # Secondary region, GDPR compliance

    # User population
    user_population:
      - Europe (EU, UK, Norway, Switzerland)
      - Total users: ~300,000
      - Peak traffic: 6,000 req/min

    # Infrastructure
    infrastructure:
      api_pods: 6
      worker_pods: 12
      redis_cluster:
        nodes: 6  # 3 primary + 3 replicas
        instance_type: cache.r6g.large
        memory: 16GB
      postgres:
        instances: 3  # Primary + 2 replicas
        instance_type: db.r6g.xlarge
        storage: 300GB

    # Claude API routing
    claude_api:
      endpoint: https://api.anthropic.com
      region_preference: eu-west

    # Data residency (GDPR)
    data_residency:
      - EU users: MUST store data in eu-west-1 (GDPR Article 44)
      - UK users: Data stored in eu-west-1 (post-Brexit adequacy decision)
      - NO data transfer to US without explicit consent
      - Data retention: 90 days (GDPR Article 17)

    # Compliance
    compliance:
      gdpr: enabled
      data_protection_officer: dpo@company.com
      representative_eu: legal-eu@company.com

    # Networking
    networking:
      load_balancer: alb-agent-eu-west.company.com
      public_endpoint: https://api-eu.agent.company.com
      vpc_cidr: 10.1.0.0/16
      availability_zones: [eu-west-1a, eu-west-1b, eu-west-1c]

# =========================================================================
# Region: Asia-Pacific
# =========================================================================
  - name: ap-southeast-1
    cloud_provider: aws
    location: Singapore
    timezone: Asia/Singapore (UTC+8)
    primary: false  # Secondary region for APAC

    # User population
    user_population:
      - Asia-Pacific (Singapore, Australia, Japan, India)
      - Total users: ~200,000
      - Peak traffic: 4,000 req/min

    # Infrastructure (smaller, can scale as needed)
    infrastructure:
      api_pods: 4
      worker_pods: 8
      redis_cluster:
        nodes: 4  # 2 primary + 2 replicas
        instance_type: cache.r6g.large
        memory: 16GB
      postgres:
        instances: 2  # Primary + 1 replica
        instance_type: db.r6g.large
        storage: 200GB

    # Claude API routing
    claude_api:
      endpoint: https://api.anthropic.com
      region_preference: us-west  # No APAC endpoint, use US-West for lower latency

    # Data residency
    data_residency:
      - Singapore users: Data stored in ap-southeast-1 (PDPA compliant)
      - Australian users: Data stored in ap-southeast-1 (Privacy Act compliant)
      - Japan users: Data can stay in ap-southeast-1 (APPI compliant)
      - Supports data localization requirements

    # Compliance
    compliance:
      pdpa_singapore: enabled  # Personal Data Protection Act
      privacy_act_australia: enabled
      appi_japan: enabled  # Act on Protection of Personal Information

    # Networking
    networking:
      load_balancer: alb-agent-ap-southeast.company.com
      public_endpoint: https://api-ap.agent.company.com
      vpc_cidr: 10.2.0.0/16
      availability_zones: [ap-southeast-1a, ap-southeast-1b, ap-southeast-1c]

# =========================================================================
# Global Configuration
# =========================================================================
global:
  # DNS and routing
  dns:
    provider: route53
    domain: agent.company.com
    routing_policy: geolocation  # Route based on user location
    health_check_interval: 30s
    failover_enabled: true

  # Monitoring
  monitoring:
    global_prometheus: https://prometheus.company.com
    grafana_dashboard: https://grafana.company.com/d/global-agent
    alerting: pagerduty

  # Disaster recovery
  disaster_recovery:
    rto: 15 minutes  # Recovery Time Objective
    rpo: 5 minutes   # Recovery Point Objective
    backup_frequency: hourly
    backup_retention: 30 days
    cross_region_replication: enabled

  # Cost optimization
  cost_optimization:
    auto_scaling: enabled
    spot_instances: enabled_for_workers  # Workers can tolerate interruption
    reserved_instances: enabled_for_databases

  # Security
  security:
    encryption_at_rest: enabled
    encryption_in_transit: enabled (TLS 1.3)
    vpc_peering: enabled_between_regions
    firewall: cloudflare_waf
    ddos_protection: aws_shield

# =========================================================================
# Deployment Strategy
# =========================================================================
deployment:
  strategy: rolling_update

  # Order of deployment (to minimize risk)
  deployment_order:
    1: ap-southeast-1  # Smallest region first
    2: eu-west-1       # Medium region
    3: us-east-1       # Largest region last

  # Canary deployment per region
  canary:
    enabled: true
    percentage: 10%
    duration: 30m
    auto_rollback: true
    metrics_to_watch:
      - error_rate < 1%
      - p95_latency < 10s
      - availability > 99.9%

  # Rollout configuration
  rollout:
    max_surge: 25%        # Max pods above desired during update
    max_unavailable: 10%  # Max pods unavailable during update

  # Health checks
  health_checks:
    liveness_probe:
      path: /health/live
      interval: 10s
      timeout: 5s
      failure_threshold: 3
    readiness_probe:
      path: /health/ready
      interval: 5s
      timeout: 3s
      failure_threshold: 2

# =========================================================================
# Traffic Distribution (Target)
# =========================================================================
traffic_distribution:
  # Geographic distribution
  by_region:
    us-east-1: 50%      # North America
    eu-west-1: 30%      # Europe
    ap-southeast-1: 20%  # Asia-Pacific

  # By user type
  by_tier:
    enterprise: 40%  # High-value customers
    professional: 35%
    free: 25%

  # Time-based patterns
  peak_hours:
    us-east-1: 09:00-17:00 EST (14:00-22:00 UTC)
    eu-west-1: 09:00-17:00 GMT (09:00-17:00 UTC)
    ap-southeast-1: 09:00-17:00 SGT (01:00-09:00 UTC)

  # Follow-the-sun coverage: Peak hours spread across 24 hours globally

# =========================================================================
# Estimated Costs (Monthly)
# =========================================================================
estimated_costs:
  us-east-1:
    compute: $5,000   # EKS nodes
    database: $3,000  # PostgreSQL RDS
    cache: $1,500     # ElastiCache Redis
    networking: $800  # Load balancer, data transfer
    storage: $200     # S3, EBS
    total: $10,500

  eu-west-1:
    compute: $3,000
    database: $1,800
    cache: $900
    networking: $500
    storage: $150
    total: $6,350

  ap-southeast-1:
    compute: $2,000
    database: $1,200
    cache: $600
    networking: $400
    storage: $100
    total: $4,300

  # Claude API costs (global)
  claude_api: $15,000  # Depends on usage

  # Monitoring and tooling
  monitoring: $1,000

  # Grand total
  grand_total: $37,150/month

# =========================================================================
# Notes
# =========================================================================
# - This configuration should be version controlled
# - Changes require approval from: Engineering Lead + SRE Team
# - Test changes in staging environment first
# - Follow deployment runbook for production rollout
# - Monitor for 24 hours after any configuration change
